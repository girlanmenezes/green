import Conection
import datetime
#from ..resources.variables import TODAY, RETROATIVA

class DB:
    def get_conta_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO = 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5402851','5420277','5457682','5461959','5462549','5462569','5467861','5467872','5474772','5476227','5476663','5484370','5487460','5507183','5508723','5511297','5511947','5512609','5512850','5514467','5514947','5515541','5515634','5515649','5515965','5516338','5517345','5517354','5517422','5517901','5519031','5520345','5520478','5520552','5520778','5520920','5523004','5523029','5523328','5524302','5524465','5524790','5525075','5527413','5527524','5529362','5530186','5530211','5531405','5531744','5531778','5531872','5531946','5532124','5532340','5532420','5532488','5532504','5532510','5532511','5532585','5532643','5532742','5532756','5532768','5532793','5532804','5532912','5532913','5532953','5532970','5533000','5533017','5533042','5533086','5533131','5533393','5533461','5533532','5533826','5533979','5534008','5534038','5534122','5534128','5534244','5534346','5534650','5534843','5534848','5534865','5534950','5535340','5535481','5535779','5535895','5535989','5536015','5536068','5536076','5536387','5536538','5536551','5536557','5536608','5536614','5536673','5536935','5536976','5537035','5537058','5537117','5537170','5537184','5537186','5537211','5537231','5537256','5537321','5537591','5537681','5537988','5538170','5538304','5538430','5538448','5538521','5538850','5538853','5538860','5538866','5538900','5539409','5539564','5539808','5539822','5540004','5540140','5540172','5540231','5540280','5540327','5540330','5540350','5540351','5540362','5540365','5540385','5540586','5540958','5540965','5540990','5541130','5541214','5541294','5541356','5541428','5541457','5541498','5541502','5541518','5541752','5541830','5541880','5541975','5541983','5541993','5541994','5542037','5542046','5542095','5542145','5542151','5542177','5542183','5542195','5542212','5542215','5542220','5542275','5542361','5542390','5542480','5542559','5542571','5542636','5542720','5542822','5542912','5543187','5543467','5543542','5543617','5543667','5543708','5543854','5543859','5543875','5544072','5544163','5544223','5544498','5544588','5545309','5545483','5545540','5545724','5545739','5546020','5546184','5546354','5546582','5546764','5546814','5546909','5547003','5547041','5547067','5547217','5547282','5547436','5547453','5547564','5547845','5547916','5548038','5548282','5548294','5548433','5548448','5549081','5549102','5549159','5549253','5549272','5549284','5549292','5549406','5549457','5549466','5549467','5549523','5549532','5549549','5549592','5549596','5549619','5549649','5557645','5559532','5561825','5577957','5583601','5594973','5595079','5595121','5595122','5596801','5598172','5599354','5600316','5601561','5601587','5601589','5601633','5603104','5603382','5604124','5604187','5604283','5604564','5605504','5606022','5607261','5607366','5607766','5607769','5609482','5609628','5609775','5609878','5610773','5610776','5614190','5619391','5623289','5624778','5626576','5628033','5630906','5638128','5642335','5644079','5645771','5645912','5646277','5646832','5648966','5649686','5654229','5654970','5655092','5655359','5656635','5656812','5658861','5659416','5659811','5659933','5660160','5660168','5662074','5662328','5662349','5662364','5664264','5664275','5666047','5666063','5666119','5669000','5669411','5669536','5669746','5670649','5670679','5671056','5671097','5671125','5672133','5673007','5673861','5673870','5673906','5674194','5674253','5674302','5674306','5674364','5674499','5674660','5674703','5674713','5674725','5674734','5674914','5675007','5675081','5675653','5675740','5675786','5676461','5678313','5678546','5683466','5684605','5685015','5687225')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results

    def get_atendimento_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO != 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5402851','5420277','5457682','5461959','5462549','5462569','5467861','5467872','5474772','5476227','5476663','5484370','5487460','5507183','5508723','5511297','5511947','5512609','5512850','5514467','5514947','5515541','5515634','5515649','5515965','5516338','5517345','5517354','5517422','5517901','5519031','5520345','5520478','5520552','5520778','5520920','5523004','5523029','5523328','5524302','5524465','5524790','5525075','5527413','5527524','5529362','5530186','5530211','5531405','5531744','5531778','5531872','5531946','5532124','5532340','5532420','5532488','5532504','5532510','5532511','5532585','5532643','5532742','5532756','5532768','5532793','5532804','5532912','5532913','5532953','5532970','5533000','5533017','5533042','5533086','5533131','5533393','5533461','5533532','5533826','5533979','5534008','5534038','5534122','5534128','5534244','5534346','5534650','5534843','5534848','5534865','5534950','5535340','5535481','5535779','5535895','5535989','5536015','5536068','5536076','5536387','5536538','5536551','5536557','5536608','5536614','5536673','5536935','5536976','5537035','5537058','5537117','5537170','5537184','5537186','5537211','5537231','5537256','5537321','5537591','5537681','5537988','5538170','5538304','5538430','5538448','5538521','5538850','5538853','5538860','5538866','5538900','5539409','5539564','5539808','5539822','5540004','5540140','5540172','5540231','5540280','5540327','5540330','5540350','5540351','5540362','5540365','5540385','5540586','5540958','5540965','5540990','5541130','5541214','5541294','5541356','5541428','5541457','5541498','5541502','5541518','5541752','5541830','5541880','5541975','5541983','5541993','5541994','5542037','5542046','5542095','5542145','5542151','5542177','5542183','5542195','5542212','5542215','5542220','5542275','5542361','5542390','5542480','5542559','5542571','5542636','5542720','5542822','5542912','5543187','5543467','5543542','5543617','5543667','5543708','5543854','5543859','5543875','5544072','5544163','5544223','5544498','5544588','5545309','5545483','5545540','5545724','5545739','5546020','5546184','5546354','5546582','5546764','5546814','5546909','5547003','5547041','5547067','5547217','5547282','5547436','5547453','5547564','5547845','5547916','5548038','5548282','5548294','5548433','5548448','5549081','5549102','5549159','5549253','5549272','5549284','5549292','5549406','5549457','5549466','5549467','5549523','5549532','5549549','5549592','5549596','5549619','5549649','5557645','5559532','5561825','5577957','5583601','5594973','5595079','5595121','5595122','5596801','5598172','5599354','5600316','5601561','5601587','5601589','5601633','5603104','5603382','5604124','5604187','5604283','5604564','5605504','5606022','5607261','5607366','5607766','5607769','5609482','5609628','5609775','5609878','5610773','5610776','5614190','5619391','5623289','5624778','5626576','5628033','5630906','5638128','5642335','5644079','5645771','5645912','5646277','5646832','5648966','5649686','5654229','5654970','5655092','5655359','5656635','5656812','5658861','5659416','5659811','5659933','5660160','5660168','5662074','5662328','5662349','5662364','5664264','5664275','5666047','5666063','5666119','5669000','5669411','5669536','5669746','5670649','5670679','5671056','5671097','5671125','5672133','5673007','5673861','5673870','5673906','5674194','5674253','5674302','5674306','5674364','5674499','5674660','5674703','5674713','5674725','5674734','5674914','5675007','5675081','5675653','5675740','5675786','5676461','5678313','5678546','5683466','5684605','5685015','5687225')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results
