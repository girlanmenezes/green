import Conection
import datetime
#from ..resources.variables import TODAY, RETROATIVA

class DB:
    def get_conta_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO = 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5595277','5606057','5611917','5642323','5614573','5622662','5606005','5604587','5590457','5631088','5636069','5617293','5613367','5609628','5604187','5602878','5633917','5581097','5591843','5550396','5548858','5547817','5545399','5546817','5601619','5635381','5639321','5628428','5596595','5595296','5633919','5653497','5657249','5654141','5657228','5658527','5649168','5653536','5659311','5646574','5659465','5651571','5653385','5653306','5655056','5633845','5623130','5661521','5661655','5627043','5650802','5621810','5638666','5656519','5641115','5654955','5577957','5583601','5587016','5617291','5595122','5594973','5601587','5605504','5609482','5596801','5609878','5606022','5610776','5603382','5604124','5601561','5598172','5604564','5601633','5599354','5610773','5600316','5607769','5595079','5609775','5607766','5601589','5595121','5604283','5582377','5614589','5618080','5602372','5583289','5571287','5578565','5589974','5591458','5587325','5594715','5567736','5587722','5589055','5588494','5609804','5586832','5600934','5612974','5615672','5615753','5617133','5618977','5619383','5610837','5621572','5602543','5548445','5549703','5555976','5558446','5561825','5559532','5543897','5557645','5549704','5565107','5555216','5538309','5507192','5526974','5493230','5490456','5492187','5534199')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results

    def get_atendimento_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO != 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5595277','5606057','5611917','5642323','5614573','5622662','5606005','5604587','5590457','5631088','5636069','5617293','5613367','5609628','5604187','5602878','5633917','5581097','5591843','5550396','5548858','5547817','5545399','5546817','5601619','5635381','5639321','5628428','5596595','5595296','5633919','5653497','5657249','5654141','5657228','5658527','5649168','5653536','5659311','5646574','5659465','5651571','5653385','5653306','5655056','5633845','5623130','5661521','5661655','5627043','5650802','5621810','5638666','5656519','5641115','5654955','5577957','5583601','5587016','5617291','5595122','5594973','5601587','5605504','5609482','5596801','5609878','5606022','5610776','5603382','5604124','5601561','5598172','5604564','5601633','5599354','5610773','5600316','5607769','5595079','5609775','5607766','5601589','5595121','5604283','5582377','5614589','5618080','5602372','5583289','5571287','5578565','5589974','5591458','5587325','5594715','5567736','5587722','5589055','5588494','5609804','5586832','5600934','5612974','5615672','5615753','5617133','5618977','5619383','5610837','5621572','5602543','5548445','5549703','5555976','5558446','5561825','5559532','5543897','5557645','5549704','5565107','5555216','5538309','5507192','5526974','5493230','5490456','5492187','5534199')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results
