import Conection
import datetime
#from ..resources.variables import TODAY, RETROATIVA

class DB:
    def get_conta_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO = 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5587016','5617291','5600724','5601755','5600731','5601255','5602463','5602933','5602446','5613870','5615308','5597551','5610532','5589290','5613842','5613846','5615269','5606917','5588967','5588958','5587095','5607291','5614241','5610299','5613905','5615455','5613866','5607058','5610233','5587839','5588942','5609899','5605961','5598042','5615341','5605952','5604605','5603795','5619285','5601592','5595122','5594973','5601587','5601599','5605504','5609482','5596801','5620757','5609878','5604285','5602821','5606022','5603963','5610776','5603382','5604124','5602410','5601561','5598172','5604564','5606819','5601633','5603932','5603109','5599354','5610773','5600316','5607769','5619052','5603177','5603142','5603575','5595079','5609775','5607766','5601589','5595121','5604794','5605880','5591491','5604283','5603977','5589630','5604296','5604205','5604193','5603869','5604127','5604239','5604121','5603969','5605917','5604069','5603450','5582377','5604151','5606026','5605206','5605769','5605931','5614589','5604898','5606006','5605707','5606007','5605183','5613291','5607788','5610358','5610114','5610070','5608027','5613782','5610916','5608488','5609509','5608678','5619521','5620726','5613737','5613776','5613618','5618080','5613960','5613664','5613675','5619305','5613840','5619229','5597529','5613807','5613627','5618715','5619352','5577347','5613681','5613567','5619215','5613610','5581215','5535455','5612764','5602372')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results

    def get_atendimento_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO != 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5587016','5617291','5600724','5601755','5600731','5601255','5602463','5602933','5602446','5613870','5615308','5597551','5610532','5589290','5613842','5613846','5615269','5606917','5588967','5588958','5587095','5607291','5614241','5610299','5613905','5615455','5613866','5607058','5610233','5587839','5588942','5609899','5605961','5598042','5615341','5605952','5604605','5603795','5619285','5601592','5595122','5594973','5601587','5601599','5605504','5609482','5596801','5620757','5609878','5604285','5602821','5606022','5603963','5610776','5603382','5604124','5602410','5601561','5598172','5604564','5606819','5601633','5603932','5603109','5599354','5610773','5600316','5607769','5619052','5603177','5603142','5603575','5595079','5609775','5607766','5601589','5595121','5604794','5605880','5591491','5604283','5603977','5589630','5604296','5604205','5604193','5603869','5604127','5604239','5604121','5603969','5605917','5604069','5603450','5582377','5604151','5606026','5605206','5605769','5605931','5614589','5604898','5606006','5605707','5606007','5605183','5613291','5607788','5610358','5610114','5610070','5608027','5613782','5610916','5608488','5609509','5608678','5619521','5620726','5613737','5613776','5613618','5618080','5613960','5613664','5613675','5619305','5613840','5619229','5597529','5613807','5613627','5618715','5619352','5577347','5613681','5613567','5619215','5613610','5581215','5535455','5612764','5602372')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results
