import Conection
import datetime
#from ..resources.variables import TODAY, RETROATIVA

class DB:
    def get_conta_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO = 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5147850','5177737','5161475','5162485','5161484','5162003','5163192','5163644','5163171','5174379','5175759','5158310','5171101','5150170','5174354','5174358','5175727','5167540','5149855','5149848','5147924','5167925','5174717','5170877','5174415','5175911','5174374','5167692','5170813','5148708','5149834','5170483','5166631','5158777','5175797','5166622','5165250','5164500','5179680','5162358','5155898','5155766','5162356','5162363','5166159','5170113','5157552','5181179','5170457','5164963','5163526','5166687','5164675','5171349','5164064','5164811','5163138','5162329','5158911','5165212','5167434','5162378','5164642','5163830','5160098','5171345','5161048','5168423','5179499','5163877','5163851','5164275','5155856','5170364','5168419','5162357','5155897','5165433','5166550','5152328','5164962','5164686','5150491','5164974','5164894','5164876','5164581','5164814','5164926','5164808','5164680','5166587','5164757','5164142','5143194','5164835','5166691','5165855','5166434','5166601','5175062','5165534','5166671','5166364','5166672','5165830','5173823','5168439','5170927','5170694','5170650','5168645','5174291','5171499','5169104','5170136','5169293','5179914','5181155','5174244','5174286','5174161','5178490','5174462','5174198','5174203','5179701','5174353','5179629','5158268','5174319','5174170','5179174','5179748','5138263','5174205','5174112','5179618','5174152','5142007','5097167','5173303','5163099')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results

    def get_atendimento_banco(self, day):
        date_now = datetime.datetime.now()
        date_retroativa = date_now - datetime.timedelta(days=day)

        TODAY = date_now.strftime("%d/%m/%Y")
        RETROATIVA = date_retroativa.strftime("%d/%m/%Y")
        print(TODAY)
        print(RETROATIVA)
       
        #query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa , TG.CD_CONVENIO AS cdConvenio , TG.CD_ATENDIMENTO AS cdAtendimento , TM.NR_LOTE AS grd , A.DS_AGRUPAMENTO AS agrupamento , TM.NR_PROTOCOLO_RETORNO AS nrProtocolo , TG.NR_GUIA AS nrGuia , TG.CD_SENHA AS senhaGuia , TG.CD_OPERADORA_EXE AS cdReferenciado , TG.NR_CARTEIRA AS cdSegurado , TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM , DBAMV.TISS_LOTE TL , DBAMV.TISS_GUIA TG , DBAMV.REMESSA_FATURA RF , DBAMV.AGRUPAMENTO A WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN ( 59,104,236 ) AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY')"
        query = f"SELECT DISTINCT TM.NR_DOCUMENTO AS cdRemessa, TG.CD_CONVENIO AS cdConvenio, TG.CD_ATENDIMENTO AS cdAtendimento, ATEND.TP_ATENDIMENTO AS TipoAtendimento, TM.NR_LOTE AS grd, A.DS_AGRUPAMENTO AS agrupamento, TM.NR_PROTOCOLO_RETORNO AS nrProtocolo, TG.NR_GUIA AS nrGuia, TG.CD_SENHA AS senhaGuia, nvl(tg.cd_reg_amb, tg.cd_reg_fat) nrConta, TG.CD_OPERADORA_EXE AS cdReferenciado, TG.NR_CARTEIRA AS cdSegurado, TO_CHAR(RF.DT_FECHAMENTO, 'DD/MM/YYYY HH24:MI:SS') AS dtRetorno FROM DBAMV.TISS_MENSAGEM TM, DBAMV.TISS_LOTE TL, DBAMV.TISS_GUIA TG, DBAMV.REMESSA_FATURA RF, DBAMV.AGRUPAMENTO A, DBAMV.ATENDIME ATEND WHERE RF.CD_AGRUPAMENTO = A.CD_AGRUPAMENTO AND TM.NR_PROTOCOLO_RETORNO IS NOT NULL AND TM.TP_TRANSACAO = 'ENVIO_LOTE_GUIAS' AND TM.ID = TL.ID_PAI AND TL.ID = TG.ID_PAI AND TM.NR_DOCUMENTO = TO_CHAR(RF.CD_REMESSA) AND TG.CD_CONVENIO IN (59, 104, 236) AND ATEND.CD_ATENDIMENTO = TG.CD_ATENDIMENTO AND ATEND.TP_ATENDIMENTO != 'I' AND TRUNC(RF.DT_FECHAMENTO) BETWEEN TO_DATE('{RETROATIVA}', 'DD/MM/YYYY') AND TO_DATE('{TODAY}', 'DD/MM/YYYY') AND ATEND.CD_ATENDIMENTO IN ('5147850','5177737','5161475','5162485','5161484','5162003','5163192','5163644','5163171','5174379','5175759','5158310','5171101','5150170','5174354','5174358','5175727','5167540','5149855','5149848','5147924','5167925','5174717','5170877','5174415','5175911','5174374','5167692','5170813','5148708','5149834','5170483','5166631','5158777','5175797','5166622','5165250','5164500','5179680','5162358','5155898','5155766','5162356','5162363','5166159','5170113','5157552','5181179','5170457','5164963','5163526','5166687','5164675','5171349','5164064','5164811','5163138','5162329','5158911','5165212','5167434','5162378','5164642','5163830','5160098','5171345','5161048','5168423','5179499','5163877','5163851','5164275','5155856','5170364','5168419','5162357','5155897','5165433','5166550','5152328','5164962','5164686','5150491','5164974','5164894','5164876','5164581','5164814','5164926','5164808','5164680','5166587','5164757','5164142','5143194','5164835','5166691','5165855','5166434','5166601','5175062','5165534','5166671','5166364','5166672','5165830','5173823','5168439','5170927','5170694','5170650','5168645','5174291','5171499','5169104','5170136','5169293','5179914','5181155','5174244','5174286','5174161','5178490','5174462','5174198','5174203','5179701','5174353','5179629','5158268','5174319','5174170','5179174','5179748','5138263','5174205','5174112','5179618','5174152','5142007','5097167','5173303','5163099')"
        print(query)
        conecction = Conection.Banco.create_db_connection()
        results = Conection.Banco.read_query(conecction, query)
        print(results)
        if results is None or results == []:
            results = False

        return results
